// Code generated by flutter_gopher. DO NOT EDIT.
package {{.PackageName}}

import com.sun.jna.Library
import com.sun.jna.Native
import com.sun.jna.Pointer
import com.sun.jna.Structure
import java.nio.charset.StandardCharsets

typealias Error = String?

interface FgBridgeDelegate {
    fun methodHandle(method: String, data: ByteArray?): Result<ByteArray?>
}

abstract class FgBridge {
    companion object {
        @Volatile
        private var instance: FgBridge? = null

        @JvmStatic
        fun sharedInstance(): FgBridge {
            return instance ?: synchronized(this) {
                instance ?: Bridge().also {
                    instance = it
                }
            }
        }
    }

    var delegate: FgBridgeDelegate? = null

    abstract fun callGoMethod(method: String, data: ByteArray? = null): Result<ByteArray?>
    abstract fun callDartMethod(method: String, data: ByteArray? = null)
}

private class Bridge : FgBridge() {
    private val bridgeLib: BridgeLib = Native.load("{{.LibName}}", BridgeLib::class.java)
    private var methodHandle: FgNativeMethodHandleCallback

    init {
        methodHandle = object : FgNativeMethodHandleCallback {
            override fun invoke(request: FgRequest.ByValue, response: FgResponse.ByReference) {
                methodHandle(request, response)
            }
        }
        bridgeLib.fg_init_native_method_handle_{{.Timestamp}}(methodHandle)
    }

    override
    fun callGoMethod(method: String, data: ByteArray?): Result<ByteArray?> {
        if (method.isEmpty()) return Result.success(null)

        val request = FgRequest.ByValue()
        request.method = mapFgDataFromString(method)
        request.data = mapFgDataFromBytes(data)

        val response = bridgeLib.fg_call_go_method_{{.Timestamp}}(request)

        val result = mapFgDataToBytes(response.data)
        val error = mapFgDataToError(response.error)
        if (error != null) {
            return Result.failure(Exception(error))
        }
        return Result.success(result)
    }

    override
    fun callDartMethod(method: String, data: ByteArray?) {
        if (method.isEmpty()) return

        val request = FgRequest.ByValue()
        request.method = mapFgDataFromString(method)
        request.data = mapFgDataFromBytes(data)

        bridgeLib.fg_call_dart_method_{{.Timestamp}}(request)
    }

    private fun freeFgData(value: FgData) {
        if (value.data != null) {
            Native.free(Pointer.nativeValue(value.data))
            value.data = null
            value.size = 0
        }
    }

    private fun mapFgDataFromBytes(from: ByteArray?): FgData.ByValue {
        val result = FgData.ByValue()
        if (from != null) {
            val memory = Pointer(Native.malloc(from.size.toLong()))
            memory.write(0, from, 0, from.size)
            result.data = memory
            result.size = from.size
        }
        return result
    }

    private fun mapFgDataToBytes(from: FgData): ByteArray? {
        if (from.data == null) return null
        val result = from.data!!.getByteArray(0, from.size)
        freeFgData(from)
        return result
    }

    private fun mapFgDataFromString(from: String): FgData.ByValue {
        val bytes = from.toByteArray(Charsets.UTF_8)
        return mapFgDataFromBytes(bytes)
    }

    private fun mapFgDataToString(from: FgData): String {
        val bytes = mapFgDataToBytes(from) ?: return ""
        return String(bytes, StandardCharsets.UTF_8)
    }

    private fun mapFgDataFromError(from: Error): FgData.ByValue {
        if (from == null) return FgData.ByValue()
        return mapFgDataFromString(from)
    }

    private fun mapFgDataToError(from: FgData): Error {
        if (from.data == null) return null
        return mapFgDataToString(from)
    }

    private fun methodHandle(request: FgRequest.ByValue, response: FgResponse.ByReference) {
        val method = mapFgDataToString(request.method)
        val data = mapFgDataToBytes(request.data)

        if (delegate == null) {
            response.error =
                mapFgDataFromError("call native method: $method, error: delegate is null")
            return
        }

        try {
            val result = delegate!!.methodHandle(method, data)
            if (result.isSuccess) {
                response.data = mapFgDataFromBytes(result.getOrNull())
            } else {
                response.error =
                    mapFgDataFromError("call native method: $method, error: ${result.exceptionOrNull()?.message}")
            }
        } catch (e: Throwable) {
            response.error =
                mapFgDataFromError("call native method: $method, caught err: ${e.message}")
        }
    }
}

@Structure.FieldOrder("data", "size")
private open class FgData private constructor() : Structure() {
    class ByValue : FgData(), Structure.ByValue

    @JvmField
    var data: Pointer? = null

    @JvmField
    var size: Int = 0
}

@Structure.FieldOrder("method", "data")
private open class FgRequest private constructor() : Structure() {
    class ByValue : FgRequest(), Structure.ByValue
    class ByReference : FgRequest(), Structure.ByReference

    @JvmField
    var method: FgData.ByValue = FgData.ByValue()

    @JvmField
    var data: FgData.ByValue = FgData.ByValue()
}

@Structure.FieldOrder("data", "error")
private open class FgResponse private constructor() : Structure() {
    class ByValue : FgResponse(), Structure.ByValue
    class ByReference : FgResponse(), Structure.ByReference

    @JvmField
    var data: FgData.ByValue = FgData.ByValue()

    @JvmField
    var error: FgData.ByValue = FgData.ByValue()
}

private interface BridgeLib : Library {
    fun fg_init_native_method_handle_{{.Timestamp}}(handle: FgNativeMethodHandleCallback)
    fun fg_call_dart_method_{{.Timestamp}}(request: FgRequest.ByValue)
    fun fg_call_go_method_{{.Timestamp}}(request: FgRequest.ByValue): FgResponse.ByValue
}

private interface FgNativeMethodHandleCallback : com.sun.jna.Callback {
    fun invoke(request: FgRequest.ByValue, response: FgResponse.ByReference)
}
