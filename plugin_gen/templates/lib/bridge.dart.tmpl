// Code generated by flutter_gopher. DO NOT EDIT.
// ignore_for_file: camel_case_types, non_constant_identifier_names, unused_element, unused_import
import 'dart:async';
import 'dart:convert';
import 'dart:ffi' as ffi;
import 'dart:isolate';
import 'dart:typed_data';
import 'package:ffi/ffi.dart';
import 'package:flutter_gopher/flutter_gopher.dart';

class FgBridge {
  static final _api = _bridge();

  static Uint8List? callGoMethod(String method, {Uint8List? data}) =>
      _api.callGoMethod(method, data: data);
  static Future<Uint8List?> callGoMethodAsync(String method,
          {Uint8List? data}) =>
      _api.callGoMethodAsync(method, data: data);
  static Uint8List? callNativeMethod(String method, {Uint8List? data}) =>
      _api.callNativeMethod(method, data: data);
  static Future<Uint8List?> callNativeMethodAsync(String method,
          {Uint8List? data}) =>
      _api.callNativeMethodAsync(method, data: data);
}

final _lib = FgLoader('{{.LibName}}');
final void Function(ffi.Pointer<ffi.Void>, int) _fgInitDartApi = _lib
    .lookup<ffi.NativeFunction<ffi.Void Function(ffi.Pointer<ffi.Void>, ffi.Int64)>>(
        'fg_init_dart_api')
    .asFunction();
final _fgPacket Function(_fgPacket) _fgCallGoMethod = _lib
    .lookup<ffi.NativeFunction<_fgPacket Function(_fgPacket)>>(
        'fg_call_go_method')
    .asFunction();
final void Function(int, _fgPacket) _fgCallGoMethodAsync = _lib
    .lookup<ffi.NativeFunction<ffi.Void Function(ffi.Int64, _fgPacket)>>(
        'fg_call_go_method_async')
    .asFunction();
final _fgPacket Function(_fgPacket) _fgCallNativeMethod = _lib
    .lookup<ffi.NativeFunction<_fgPacket Function(_fgPacket)>>(
        'fg_call_native_method')
    .asFunction();
final void Function(int, _fgPacket) _fgCallNativeMethodAsync = _lib
    .lookup<ffi.NativeFunction<ffi.Void Function(ffi.Int64, _fgPacket)>>(
        'fg_call_native_method_async')
    .asFunction();
final _fgData Function() _fgEmptyData = _lib
    .lookup<ffi.NativeFunction<_fgData Function()>>('fg_empty_data')
    .asFunction();
final _fgPacket Function() _fgEmptyPacket = _lib
    .lookup<ffi.NativeFunction<_fgPacket Function()>>('fg_empty_packet')
    .asFunction();

class _bridge {
  _bridge() {
    final receivePort = ReceivePort();
    receivePort.listen((addr) {
      final packetPtr = ffi.Pointer.fromAddress(addr).cast<_fgPacket>();
      final packet = packetPtr[0];
      final method = _mapFgDataToString(packet.method);
      final data = _mapFgDataToBytes(packet.data);
      print(
          'Dart Received: $method ${data != null ? data.map((b) => b.toRadixString(16).padLeft(2, '0')).join(' ') : 'null'}');
      _freeFgPacket(packet);
      malloc.free(packetPtr);
    });
    _fgInitDartApi(
        ffi.NativeApi.initializeApiDLData, receivePort.sendPort.nativePort);
  }

  Uint8List? callGoMethod(String method, {Uint8List? data}) {
    final packet = _mapToPacket(method, data);
    final c_result = _fgCallGoMethod(packet);
    final result = _mapFgDataToBytes(c_result.data);
    _freeFgPacket(c_result);
    return result;
  }

  Future<Uint8List?> callGoMethodAsync(String method, {Uint8List? data}) async {
    final receivePort = ReceivePort();
    final packet = _mapToPacket(method, data);
    _fgCallGoMethodAsync(receivePort.sendPort.nativePort, packet);
    final cResultAddr = await receivePort.first;
    final cResultPtr = ffi.Pointer.fromAddress(cResultAddr).cast<_fgPacket>();
    final cResult = cResultPtr[0];

    final result = _mapFgDataToBytes(cResult.data);
    _freeFgPacket(cResult);
    malloc.free(cResultPtr);
    return result;
  }

  Uint8List? callNativeMethod(String method, {Uint8List? data}) {
    final packet = _mapToPacket(method, data);
    final c_result = _fgCallNativeMethod(packet);
    final result = _mapFgDataToBytes(c_result.data);
    _freeFgPacket(c_result);
    return result;
  }

  Future<Uint8List?> callNativeMethodAsync(String method,
      {Uint8List? data}) async {
    final receivePort = ReceivePort();
    final packet = _mapToPacket(method, data);
    _fgCallNativeMethodAsync(receivePort.sendPort.nativePort, packet);
    final cResultAddr = await receivePort.first;
    final cResultPtr = ffi.Pointer.fromAddress(cResultAddr).cast<_fgPacket>();
    final cResult = cResultPtr[0];

    final result = _mapFgDataToBytes(cResult.data);
    _freeFgPacket(cResult);
    malloc.free(cResultPtr);
    return result;
  }
}

final class _fgData extends ffi.Struct {
  external ffi.Pointer<ffi.Void> data;
  @ffi.Int()
  external int size;
}

final class _fgPacket extends ffi.Struct {
  external _fgData method;
  external _fgData data;
}

void _freeFgPacket(_fgPacket pakcet) {
  _freeFgData(pakcet.method);
  _freeFgData(pakcet.data);
}

void _freeFgData(_fgData value) {
  if (value.data != ffi.nullptr) {
    malloc.free(value.data);
    value.data = ffi.nullptr;
    value.size = 0;
  }
}

_fgPacket _mapToPacket(String method, Uint8List? data) {
  final result = _fgEmptyPacket();
  result.method = _mapFgDataFromString(method);
  result.data = _mapFgDataFromBytes(data);
  return result;
}

Uint8List? _mapFgDataToBytes(_fgData from) {
  if (from.data == ffi.nullptr) return null;
  final data = from.data.cast<ffi.Uint8>();
  return Uint8List.fromList(data.asTypedList(from.size));
}

_fgData _mapFgDataFromBytes(Uint8List? from) {
  final result = _fgEmptyData();
  if (from != null) {
    final data = malloc<ffi.Uint8>(from.length);
    data.asTypedList(from.length).setAll(0, from);
    result.data = data.cast();
    result.size = from.length;
  }
  return result;
}

String _mapFgDataToString(_fgData from) {
  final bytes = _mapFgDataToBytes(from);
  if (bytes == null) return '';
  return const Utf8Decoder().convert(bytes);
}

_fgData _mapFgDataFromString(String from) {
  final bytes = const Utf8Encoder().convert(from);
  return _mapFgDataFromBytes(bytes);
}
